<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>福岡獨旅行程表 (即時協作版)</title>
    
    <!-- 錯誤捕捉與狀態顯示 -->
    <style>
        #status-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; color: #333; z-index: 9999; padding: 20px;
            font-family: sans-serif;
        }
        .error-box {
            border: 2px solid red;
            background: #fff0f0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .reset-btn {
            background: #ef4444; color: white; border: none; padding: 10px 20px;
            border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 20px;
        }
        .reset-btn:hover { background: #dc2626; }
    </style>
    <div id="status-overlay">
        <h2 style="color: red;">⚠️ 程式發生錯誤</h2>
        <p>這通常是因為舊的暫存資料與新版程式不相容導致。</p>
        <p>請點擊下方按鈕清除暫存並重置：</p>
        <button onclick="hardReset()" class="reset-btn">清除舊資料並修復</button>
        <div id="error-content" class="error-box"></div>
    </div>
    <script>
        function hardReset() {
            try {
                localStorage.clear();
                document.getElementById('error-content').innerText = "已清除暫存資料，網頁即將重新整理。";
                setTimeout(() => window.location.reload(), 1000);
            } catch(e) {
                document.getElementById('error-content').innerText = "清除失敗，請嘗試手動清除瀏覽器快取。";
            }
        }

        window.onerror = function(msg, url, line, col, error) {
            var overlay = document.getElementById('status-overlay');
            var content = document.getElementById('error-content');
            overlay.style.display = 'block';
            content.innerText = "錯誤訊息: " + msg + "\n位置: " + line + ":" + col;
            return false;
        };
    </script>

    <!-- 1. 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. 引入 Babel -->
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Firebase CDN (模組化引入) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // 你的 Firebase 設定檔
        const firebaseConfig = {
            apiKey: "AIzaSyC0p4Heb-L0UpmfkxMSI8ieGHTvsJ3nJ4o",
            authDomain: "fukuokaapp-b50c9.firebaseapp.com",
            projectId: "fukuokaapp-b50c9",
            storageBucket: "fukuokaapp-b50c9.firebasestorage.app",
            messagingSenderId: "901138505890",
            appId: "1:901138505890:web:ce4908aa6d8d563cfd37fb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 將方法掛載到 window 供下方的 React 程式使用
        window.firebaseAPI = { db, doc, onSnapshot, setDoc };
        window.dispatchEvent(new Event('firebase-loaded'));
    </script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        /* 基礎樣式 */
        :root {
            --font-serif: 'Noto Serif JP', serif;
            --font-sans: 'Noto Sans JP', sans-serif;
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --text-main: #e0e0e0;
            --accent-gold: #c5a059;
        }
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-sans);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        select { -webkit-appearance: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        if (typeof React === 'undefined') {
            document.getElementById('status-overlay').style.display = 'block';
            document.getElementById('error-content').innerText = "React 載入失敗，請檢查網路。";
            throw new Error("React Load Failed");
        }

        const { useState, useRef, useEffect } = React;
        const { createRoot } = ReactDOM;

        // --- 內建圖示元件 ---
        const IconBase = ({ size = 24, className = "", children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );

        const Icons = {
            MapPin: (p) => <IconBase {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>,
            Clock: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>,
            ExternalLink: (p) => <IconBase {...p}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></IconBase>,
            Utensils: (p) => <IconBase {...p}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></IconBase>,
            Bed: (p) => <IconBase {...p}><path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/></IconBase>,
            Car: (p) => <IconBase {...p}><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><path d="M9 17h6"/><circle cx="17" cy="17" r="2"/></IconBase>,
            ShoppingBag: (p) => <IconBase {...p}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></IconBase>,
            Camera: (p) => <IconBase {...p}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></IconBase>,
            Plus: (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>,
            Trash2: (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>,
            GripVertical: (p) => <IconBase {...p}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></IconBase>,
            Save: (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>,
            X: (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>,
            Link: (p) => <IconBase {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></IconBase>,
            Navigation: (p) => <IconBase {...p}><polygon points="3 11 22 2 13 21 11 13 3 11"/></IconBase>,
            RotateCcw: (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>,
            Download: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>,
            Copy: (p) => <IconBase {...p}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></IconBase>,
            Menu: (p) => <IconBase {...p}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></IconBase>
        };

        const { 
            MapPin, Clock, ExternalLink, Utensils, Bed, Car, 
            ShoppingBag, Camera, Plus, Trash2, GripVertical, 
            Save, X, Link: LinkIcon, Navigation, RotateCcw, 
            Download, Copy, Menu 
        } = Icons;

        const BANNER_IMAGE_URL = "https://lh3.googleusercontent.com/d/1mo1MaLdcHTVJ8KnhX4ijr23dY2QGC7GY"; 

        // -----------------------------------------------------------------------------
        // 初始數據
        // -----------------------------------------------------------------------------
        const INITIAL_DATA = [
            // 10月26日 (月)
            { id: '1', date: '10月26日', time: '12:40', category: '移動', title: '台北→福岡', link: '', memo: 'AK1510亞航' },
            { id: '2', date: '10月26日', time: '16:00', category: '移動', title: '福岡空港→祇園', link: '', memo: '福岡地下鉄空港線(姪浜行)，從5出站' },
            { id: '3', date: '10月26日', time: '17:30', category: '宿泊', title: 'EN HOTEL Hakata', link: 'https://maps.app.goo.gl/NjExH8YtCALANrc2A', memo: '' },
            { id: '4', date: '10月26日', time: '17:40', category: '移動', title: '櫛田神社前→天神南', link: '', memo: '' },
            { id: '5', date: '10月26日', time: '18:00', category: '食事', title: 'とんかつ わか葉', link: 'https://maps.app.goo.gl/QvWAqUibt5jgBnR59', memo: '營業時間：10:30-14:30 17:00-20:45' },

            // 10月27日 (火)
            { id: '6', date: '10月27日', time: '8:00', category: '移動', title: '博多駅貸切バス専用駐車場', link: 'https://maps.app.goo.gl/vvazSFqPyobwaX6k7', memo: '' },
            { id: '7', date: '10月27日', time: '9:05', category: '觀光', title: '雷山千如寺大悲王院', link: 'https://maps.app.goo.gl/UBBagCVPfjCKPxMr8', memo: '要買Fun Tour 九州巴士' },
            { id: '8', date: '10月27日', time: '11:35', category: '觀光', title: '松月乘船場', link: 'https://maps.app.goo.gl/4rZCWHjYj6ckn9tn6', memo: '柳川觀光開發(株)' },
            { id: '9', date: '10月27日', time: '12:35', category: '食事', title: '清柳食産', link: 'https://maps.app.goo.gl/WAdpLeQJgsJXMmjA8', memo: '營業時間：11:30 - 14:30，公休:水、日' },
            { id: '10', date: '10月27日', time: '14:55', category: '觀光', title: '太宰府天滿宮', link: 'https://maps.app.goo.gl/o6oDHKprumnZFD3R7', memo: '周邊美食' },
            { id: '11', date: '10月27日', time: '16:45', category: '觀光', title: '寶滿宮 竈門神社', link: 'https://maps.app.goo.gl/uqrcG1tqVnGoXPWbA', memo: '' },
            { id: '12', date: '10月27日', time: '19:00', category: '食事', title: 'とり田 博多本店', link: 'https://maps.app.goo.gl/Wb11R8vxjW6r2XEe9', memo: '營業時間：11:30 - 16:00 17:00 - 23:00' },

            // 10月28日 (水)
            { id: '13', date: '10月28日', time: '8:00', category: '食事', title: '麺屋 いしヰ', link: 'https://maps.app.goo.gl/MB52X8UQCZT16pU4A', memo: '營業時間：08:00 - 16:00，前兩週預定' },
            { id: '14', date: '10月28日', time: '9:00', category: '觀光', title: '櫛田神社', link: 'https://maps.app.goo.gl/mtghzfxJ3yxLpSQ59', memo: '' },
            { id: '15', date: '10月28日', time: '9:45', category: '移動', title: '櫛田神社前→博多', link: '', memo: '' },
            { id: '16', date: '10月28日', time: '10:00', category: '買物', title: '博多阪急', link: 'https://maps.app.goo.gl/xNj1fcEPsyj7NqSU9', memo: '' },
            { id: '17', date: '10月28日', time: '10:00', category: '買物', title: 'LOPIA 博多友都八喜店', link: 'https://maps.app.goo.gl/d3FaqJY3g8iY1XXx8', memo: '' },
            { id: '18', date: '10月28日', time: '11:00', category: '移動', title: '博多→櫛田神社前', link: '', memo: '' },
            { id: '19', date: '10月28日', time: '11:20', category: '移動', title: '櫛田神社前→天神南', link: '', memo: '' },
            { id: '20', date: '10月28日', time: '12:00', category: '食事', title: 'ひょうたんの回転寿司', link: 'https://maps.app.goo.gl/Z1f9X5d16yLcg5to7', memo: '營業時間：11:00 - 21:00' },
            { id: '21', date: '10月28日', time: '13:30', category: '買物', title: '天神商圈', link: 'https://www.google.com/maps/d/u/0/edit?mid=1PwbNItMBimR0RkTOnauktSvrmj63OkE&usp=sharing', memo: '' },
            { id: '22', date: '10月28日', time: '17:00', category: '移動', title: '天神大丸前→Lalaport福岡', link: 'https://maps.app.goo.gl/fLnwDzqyWMU8ri9B6', memo: '時刻表https://www.navitime.co.jp/diagram/bus/00085401/00022210/0/' },
            { id: '23', date: '10月28日', time: '17:43', category: '買物', title: 'LaLaport 福岡', link: 'https://maps.app.goo.gl/vH1fHCuazpTYgJDn9', memo: '' },
            { id: '24', date: '10月28日', time: '19:19', category: '移動', title: 'Lalaport福岡→春吉', link: '', memo: '時刻表https://www.navitime.co.jp/diagram/bus/00091093/00022210/1/' }, 
            { id: '25', date: '10月28日', time: '20:00', category: '食事', title: '博多シーフードうお田', link: 'https://maps.app.goo.gl/1swqRAikHfRMPqXT8', memo: '' },

            // 10月29日 (木)
            { id: '26', date: '10月29日', time: '7:00', category: '食事', title: 'DACOMECCA', link: 'https://maps.app.goo.gl/2nMJPmHuzDismBQM6', memo: '' },
            { id: '27', date: '10月29日', time: '8:30', category: '移動', title: '博多→門司港', link: '', memo: '博多→小倉（新幹線），小倉→門司港 (北九州周遊Pass)' },
            { id: '28', date: '10月29日', time: '09:00', category: '移動', title: '門司港→下関（唐戸）', link: 'https://maps.app.goo.gl/p12fN4g6ZJ9c8Zrw8', memo: '單程400円，時刻表https://www.kanmon-kisen.co.jp/route/kanmon.html' },
            { id: '29', date: '10月29日', time: '09:30', category: '觀光', title: '海響館', link: 'https://maps.app.goo.gl/1NvAgdXs3wMCQe5Y7', memo: '營業時間：9:30 - 17:30，2,500円' },
            { id: '30', date: '10月29日', time: '11:30', category: '食事', title: '下関 唐戸市場', link: 'https://maps.app.goo.gl/HHpj4tkK4AfchyxM7', memo: '營業時間：10:00 - 15:00' },
            { id: '31', date: '10月29日', time: '13:00', category: '觀光', title: '門司港レトロ展望室', link: 'https://maps.app.goo.gl/y8YYASgCNzWSY1kJ8', memo: '北九州周遊pass' },
            { id: '32', date: '10月29日', time: '13:30', category: '觀光', title: '海峡プラザ', link: 'https://maps.app.goo.gl/DNsGw8f6tPRCDKXQ6', memo: '伴手禮小吃' },
            { id: '33', date: '10月29日', time: '14:00', category: '移動', title: '門司港→小倉', link: '', memo: '北九州周遊pass' },
            { id: '34', date: '10月29日', time: '15:00', category: '買物', title: 'Aruaru City', link: 'https://maps.app.goo.gl/CAymEorcxp1upN7V7', memo: '' },
            { id: '35', date: '10月29日', time: '15:00', category: '觀光', title: '八坂神社', link: 'https://maps.app.goo.gl/YTiyDgXMqiisaVBa9', memo: '' },
            { id: '36', date: '10月29日', time: '15:30', category: '觀光', title: '小倉城', link: 'https://maps.app.goo.gl/gC8GK9sfqSByCvDd8', memo: '北九州周遊pass' },
            { id: '37', date: '10月29日', time: '17:30', category: '移動', title: '西小倉→八幡', link: '', memo: '北九州周遊pass' },
            { id: '38', date: '10月29日', time: '18:05', category: '移動', title: '接駁車→皿倉山', link: 'https://maps.app.goo.gl/B2M9SUyakKSLbLhe8', memo: '時刻表https://www.sarakurayama-cablecar.co.jp/shuttlebus/' },
            { id: '39', date: '10月29日', time: '18:40', category: '觀光', title: '皿倉山ケーブルカー夜景', link: '', memo: '時刻表https://www.sarakurayama-cablecar.co.jp/timetable/' },
            { id: '40', date: '10月29日', time: '19:40', category: '移動', title: '山上駅→博多', link: '', memo: '' },
            { id: '41', date: '10月29日', time: '22:30', category: '食事', title: 'にく屋 肉いち  博多店', link: 'https://maps.app.goo.gl/tW2M4KA1tEDXbHVH6', memo: '營業時間：16:00–24:00，2個月前要網路訂位' },

            // 10月30日 (金)
            { id: '42', date: '10月30日', time: '7:45', category: '移動', title: '櫛田神社前→六本松', link: '', memo: '' },
            { id: '43', date: '10月30日', time: '8:00', category: '食事', title: '炉端ノいとおかし', link: 'https://maps.app.goo.gl/8tfxDmg16DShtsKJ8', memo: '營業時間：8:00 - 14:00，近1個月要網路訂位' },
            { id: '44', date: '10月30日', time: '9:00', category: '移動', title: '六本松→天神南', link: '', memo: '' },
            { id: '45', date: '10月30日', time: '9:30', category: '食事', title: 'パンストック 天神店', link: 'https://maps.app.goo.gl/TWVyCXm3144BsL6s7', memo: '營業時間：8:00–19:00，定休日：月曜.第1･第3火曜' },
            { id: '46', date: '10月30日', time: '10:00', category: '買物', title: '博多運河城', link: 'https://maps.app.goo.gl/A5dHucXhqsb9vDZU6', memo: '' },
            { id: '47', date: '10月30日', time: '12:30', category: '食事', title: '博多元氣一杯!!', link: 'https://www.google.com/maps?cid=4563141796542890085', memo: '營業時間：11:00 - 20:00' },
            { id: '48', date: '10月30日', time: '14:30', category: '移動', title: '福岡國際機場', link: '', memo: 'AK1511 回家' },
        ];

        const WEEKDAYS = {
            '10月26日': '月',
            '10月27日': '火',
            '10月28日': '水',
            '10月29日': '木',
            '10月30日': '金',
        };

        const CATEGORIES = [
            { name: '移動', color: 'text-blue-400', bg: 'bg-blue-400/10', border: 'border-blue-400/30', icon: 'Car' },
            { name: '宿泊', color: 'text-indigo-400', bg: 'bg-indigo-400/10', border: 'border-indigo-400/30', icon: 'Bed' },
            { name: '食事', color: 'text-orange-400', bg: 'bg-orange-400/10', border: 'border-orange-400/30', icon: 'Utensils' },
            { name: '觀光', color: 'text-emerald-400', bg: 'bg-emerald-400/10', border: 'border-emerald-400/30', icon: 'Camera' },
            { name: '買物', color: 'text-pink-400', bg: 'bg-pink-400/10', border: 'border-pink-400/30', icon: 'ShoppingBag' },
            { name: '其他', color: 'text-gray-400', bg: 'bg-gray-400/10', border: 'border-gray-400/30', icon: 'MapPin' },
        ];

        // -----------------------------------------------------------------------------
        // 子組件
        // -----------------------------------------------------------------------------

        const EditModal = ({ item, isOpen, onClose, onSave, onDelete, categories, onUpdateCategories }) => {
            const [formData, setFormData] = useState(item);
            const [newCatName, setNewCatName] = useState('');
            const [isAddingCat, setIsAddingCat] = useState(false);

            useEffect(() => {
                if (item) setFormData(item);
            }, [item]);

            if (!isOpen || !formData) return null;

            const handleChange = (e) => {
                setFormData({ ...formData, [e.target.name]: e.target.value });
            };

            const handleAddCategory = () => {
                if (newCatName.trim()) {
                    onUpdateCategories([...categories, { 
                        name: newCatName, 
                        color: 'text-yellow-400', 
                        bg: 'bg-yellow-400/10', 
                        border: 'border-yellow-400/30', 
                        icon: 'MapPin' 
                    }]);
                    setFormData({ ...formData, category: newCatName });
                    setNewCatName('');
                    setIsAddingCat(false);
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm p-0 sm:p-4 animate-in fade-in duration-200">
                    <div className="bg-[#1e1e1e] w-full max-w-md rounded-t-2xl sm:rounded-2xl border border-white/10 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="flex justify-between items-center p-4 border-b border-white/10">
                            <h3 className="text-lg font-serif font-bold text-white">編輯行程</h3>
                            <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-full text-gray-400">
                                <X size={20} />
                            </button>
                        </div>

                        <div className="p-5 space-y-5 overflow-y-auto custom-scrollbar">
                            <div className="grid grid-cols-2 gap-4">
                                <div className="space-y-1">
                                    <label className="text-xs text-gray-500">時間</label>
                                    <input type="time" name="time" value={formData.time || ''} onChange={handleChange} className="w-full bg-[#2a2a2a] border border-white/10 rounded-lg p-3 text-white focus:border-[#c5a059] focus:outline-none"/>
                                </div>
                                <div className="space-y-1">
                                    <label className="text-xs text-gray-500">分類</label>
                                    {!isAddingCat ? (
                                        <div className="flex gap-2">
                                            <select name="category" value={formData.category || ''} onChange={handleChange} className="w-full bg-[#2a2a2a] border border-white/10 rounded-lg p-3 text-white focus:border-[#c5a059] focus:outline-none appearance-none">
                                                {categories.map(c => <option key={c.name} value={c.name}>{c.name}</option>)}
                                            </select>
                                            <button onClick={() => setIsAddingCat(true)} className="p-3 bg-[#2a2a2a] rounded-lg border border-white/10 text-gray-400 hover:text-[#c5a059]">
                                                <Plus size={18} />
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="flex gap-2">
                                            <input type="text" placeholder="新分類名稱" value={newCatName} onChange={(e) => setNewCatName(e.target.value)} className="w-full bg-[#2a2a2a] border border-white/10 rounded-lg p-3 text-white focus:border-[#c5a059]" autoFocus />
                                            <button onClick={handleAddCategory} className="px-3 bg-[#c5a059] text-black font-bold rounded-lg text-sm">OK</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="space-y-1">
                                <label className="text-xs text-gray-500">標題</label>
                                <input type="text" name="title" value={formData.title || ''} onChange={handleChange} className="w-full bg-[#2a2a2a] border border-white/10 rounded-lg p-3 text-white focus:border-[#c5a059] focus:outline-none font-medium"/>
                            </div>
                            <div className="space-y-1">
                                <label className="text-xs text-gray-500 flex items-center gap-2">
                                    <LinkIcon size={12} /> 地圖/網站連結 (Map Link)
                                </label>
                                <input type="text" name="link" placeholder="https://..." value={formData.link || ''} onChange={handleChange} className="w-full bg-[#2a2a2a] border border-white/10 rounded-lg p-3 text-blue-400 text-sm focus:border-[#c5a059] focus:outline-none"/>
                            </div>
                            <div className="space-y-1">
                                <label className="text-xs text-gray-500">備註 (支援超連結)</label>
                                <textarea name="memo" rows={3} value={formData.memo || ''} onChange={handleChange} placeholder="例如：需預約，網址：https://..." className="w-full bg-[#2a2a2a] border border-white/10 rounded-lg p-3 text-gray-300 text-sm focus:border-[#c5a059] focus:outline-none resize-none"/>
                            </div>
                            <button onClick={() => onDelete(formData.id)} className="w-full py-3 flex items-center justify-center gap-2 text-red-400 bg-red-400/10 rounded-lg hover:bg-red-400/20 transition-colors">
                                <Trash2 size={16} /> 刪除此行程
                            </button>
                        </div>
                        <div className="p-4 border-t border-white/10 bg-[#1e1e1e]">
                            <button onClick={() => onSave(formData)} className="w-full py-3 bg-[#c5a059] hover:bg-[#b08d4a] text-black font-bold rounded-lg shadow-lg shadow-[#c5a059]/20 transition-all flex items-center justify-center gap-2">
                                <Save size={18} /> 儲存變更
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // -----------------------------------------------------------------------------
        // 主應用程式
        // -----------------------------------------------------------------------------
        const FukuokaSoloTripApp = () => {
            const [activeDate, setActiveDate] = useState('10月26日');
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [dialog, setDialog] = useState(null); // 自訂提示框 { title?, message, onConfirm?, onCancel? }
            
            // Firebase 資料狀態
            const [items, setItems] = useState(INITIAL_DATA);
            const [categories, setCategories] = useState(CATEGORIES);
            const [isFirebaseReady, setIsFirebaseReady] = useState(false);
            const [editingItem, setEditingItem] = useState(null);

            // Drag & Drop State
            const dragItem = useRef();
            const dragOverItem = useRef();

            // 1. 偵測 Firebase 是否載入完成
            useEffect(() => {
                if (window.firebaseAPI) {
                    setIsFirebaseReady(true);
                } else {
                    const handleLoaded = () => setIsFirebaseReady(true);
                    window.addEventListener('firebase-loaded', handleLoaded);
                    return () => window.removeEventListener('firebase-loaded', handleLoaded);
                }
            }, []);

            // 2. 設定 Firestore 即時監聽 (onSnapshot)
            useEffect(() => {
                if (!isFirebaseReady) return;
                
                const { db, doc, onSnapshot, setDoc } = window.firebaseAPI;
                const docRef = doc(db, "itineraries", "fukuoka_trip");

                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.items) setItems(data.items);
                        if (data.categories) setCategories(data.categories);
                    } else {
                        // 如果雲端沒有資料，寫入預設資料
                        setDoc(docRef, { items: INITIAL_DATA, categories: CATEGORIES }, { merge: true });
                    }
                }, (error) => {
                    console.error("Firestore 即時更新失敗:", error);
                });

                return () => unsubscribe();
            }, [isFirebaseReady]);

            // 3. 共用的寫入雲端函數
            const updateFirestore = async (newItems, newCategories = categories) => {
                // 樂觀更新：立刻改變畫面狀態，不讓使用者等
                setItems(newItems);
                setCategories(newCategories);

                if (!window.firebaseAPI) return;
                const { db, doc, setDoc } = window.firebaseAPI;
                try {
                    await setDoc(doc(db, "itineraries", "fukuoka_trip"), { 
                        items: newItems,
                        categories: newCategories
                    }, { merge: true });
                } catch (error) {
                    console.error("寫入 Firestore 失敗:", error);
                    setDialog({ message: "資料同步失敗，請檢查網路連線。", onConfirm: () => setDialog(null) });
                }
            };

            const showConfirm = (message, onConfirm) => {
                setDialog({ message, onConfirm, onCancel: () => setDialog(null) });
            };

            const showAlert = (message) => {
                setDialog({ message, onConfirm: () => setDialog(null) });
            };

            // Helper: 取得分類樣式
            const getCatStyle = (catName) => {
                const found = categories.find(c => c.name === catName);
                if (!found || !found.bg) {
                    return { name: catName, color: 'text-gray-400', bg: 'bg-gray-400/10', border: 'border-gray-400/30', icon: 'MapPin' };
                }
                return found;
            };

            // Helper: 處理備註內的連結
            const renderMemoWithLinks = (text) => {
                if (!text) return null;
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                const parts = text.split(urlRegex);
                return (
                    <span className="break-words">
                        {parts.map((part, i) => 
                            part.match(urlRegex) ? (
                                <a key={i} href={part} target="_blank" rel="noopener noreferrer" className="text-blue-400 underline decoration-blue-400/50 underline-offset-2 hover:text-blue-300" onClick={(e) => e.stopPropagation()}>
                                    連結
                                </a>
                            ) : part
                        )}
                    </span>
                );
            };

            // Logic: 拖曳排序
            const handleDragStart = (e, position) => {
                dragItem.current = position;
                if (navigator.vibrate) navigator.vibrate(50);
            };

            const handleDragEnter = (e, position) => {
                dragOverItem.current = position;
            };

            const handleDrop = () => {
                if (dragItem.current === null || dragOverItem.current === null) return;
                
                const currentDayItems = items.filter(i => i.date === activeDate);
                const otherItems = items.filter(i => i.date !== activeDate);
                
                const copyListItems = [...currentDayItems];
                const dragItemContent = copyListItems[dragItem.current];
                
                copyListItems.splice(dragItem.current, 1);
                copyListItems.splice(dragOverItem.current, 0, dragItemContent);
                
                // 改用 updateFirestore
                const newItems = [...otherItems, ...copyListItems];
                updateFirestore(newItems);
                
                dragItem.current = null;
                dragOverItem.current = null;
            };

            // Logic: CRUD
            const handleSave = (newItem) => {
                const newItems = items.map(i => i.id === newItem.id ? newItem : i);
                updateFirestore(newItems);
                setEditingItem(null);
            };

            const handleDelete = (id) => {
                showConfirm('確定要刪除這個行程嗎？', () => {
                    const newItems = items.filter(i => i.id !== id);
                    updateFirestore(newItems);
                    setEditingItem(null);
                });
            };

            const handleAddNew = () => {
                const newItem = {
                    id: Date.now().toString(),
                    date: activeDate,
                    time: '00:00',
                    category: '移動',
                    title: '新行程',
                    link: '',
                    memo: ''
                };
                const newItems = [...items, newItem];
                updateFirestore(newItems);
                setEditingItem(newItem);
            };

            // Logic: Reset Data
            const handleResetData = () => {
                showConfirm('確定要重置所有行程嗎？這將會刪除您所有的修改，並變回預設狀態。', () => {
                    updateFirestore(INITIAL_DATA, CATEGORIES);
                    showAlert('行程已重置');
                });
            };

            // Logic: Export Data
            const handleExportData = () => {
                const dataStr = JSON.stringify(items, null, 2);
                
                const copyFallback = () => {
                    const textArea = document.createElement("textarea");
                    textArea.value = dataStr;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showAlert('已將行程數據複製到剪貼簿！');
                    } catch (err) {
                        console.log(dataStr);
                        showAlert('複製失敗，請按 F12 打開 Console 查看數據。');
                    }
                    document.body.removeChild(textArea);
                };

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(dataStr)
                        .then(() => showAlert('已將行程數據複製到剪貼簿！'))
                        .catch(err => copyFallback());
                } else {
                    copyFallback();
                }
            };

            const filteredItems = items.filter(item => item.date === activeDate);
            const uniqueDates = Object.keys(WEEKDAYS);

            return (
                <div className="min-h-screen pb-20 safe-bottom selection:bg-[#c5a059] selection:text-black">
                    
                    {/* 提示框 Modal */}
                    {dialog && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                            <div className="bg-[#1e1e1e] border border-white/10 rounded-xl p-6 max-w-sm w-full animate-in zoom-in-95">
                                <p className="text-white text-base mb-6">{dialog.message}</p>
                                <div className="flex justify-end gap-3">
                                    {dialog.onCancel && (
                                        <button onClick={dialog.onCancel} className="px-4 py-2 rounded-lg text-gray-400 hover:text-white transition-colors">取消</button>
                                    )}
                                    <button onClick={() => { if(dialog.onConfirm) dialog.onConfirm(); }} className="px-4 py-2 bg-[#c5a059] text-black font-bold rounded-lg shadow-lg">確定</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 1. Hero Banner */}
                    <div className="relative h-64 w-full overflow-hidden bg-black">
                        <div className="absolute inset-0 bg-gradient-to-b from-transparent via-[#121212]/50 to-[#121212] z-10" />
                        <img src={BANNER_IMAGE_URL} onError={(e) => { e.target.onerror = null; e.target.src = "https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564&auto=format&fit=crop"; }} alt="Fukuoka Trip Banner" className="w-full h-full object-cover opacity-80" />
                        
                        {/* Hamburger Menu */}
                        <button onClick={() => setIsMenuOpen(!isMenuOpen)} className="absolute top-6 right-6 z-50 p-2 bg-black/30 backdrop-blur-md rounded-full text-white/80 hover:bg-[#c5a059] hover:text-white transition-all border border-white/10">
                            <Menu size={24} />
                        </button>

                        {isMenuOpen && (
                            <>
                                <div className="fixed inset-0 z-40" onClick={() => setIsMenuOpen(false)} />
                                <div className="absolute top-20 right-6 z-50 w-56 bg-[#1e1e1e] border border-white/10 rounded-xl shadow-2xl overflow-hidden animate-in fade-in zoom-in-95 duration-200 origin-top-right">
                                    <div className="p-1">
                                        <button onClick={() => { handleExportData(); setIsMenuOpen(false); }} className="w-full flex items-center gap-3 px-4 py-3 text-sm text-gray-300 hover:bg-white/5 hover:text-[#c5a059] transition-colors rounded-lg text-left">
                                            <Copy size={16} /> <span>匯出行程數據</span>
                                        </button>
                                        <div className="h-[1px] bg-white/5 my-1" />
                                        <button onClick={() => { handleResetData(); setIsMenuOpen(false); }} className="w-full flex items-center gap-3 px-4 py-3 text-sm text-red-400 hover:bg-red-500/10 transition-colors rounded-lg text-left">
                                            <RotateCcw size={16} /> <span>重置所有行程</span>
                                        </button>
                                    </div>
                                </div>
                            </>
                        )}

                        <div className="absolute bottom-4 left-6 z-20">
                            <div className="flex items-center gap-3 mb-1">
                                <h1 className="text-4xl font-serif font-bold text-white tracking-wider" style={{ textShadow: '0 2px 10px rgba(0,0,0,0.5)' }}>福岡獨旅</h1>
                                {isFirebaseReady && <div className="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_#22c55e]" title="Firebase 即時連線中"></div>}
                            </div>
                            <div className="h-1 w-12 bg-[#c5a059] rounded-full" />
                        </div>
                    </div>

                    {/* 2. Date Navigation */}
                    <div className="sticky top-0 z-40 bg-[#121212]/95 backdrop-blur-md border-b border-white/5 shadow-lg">
                        <div className="flex overflow-x-auto no-scrollbar py-3 px-4 gap-3">
                            {uniqueDates.map((date) => {
                                const isActive = activeDate === date;
                                return (
                                    <button key={date} onClick={() => setActiveDate(date)} className={`flex flex-col items-center justify-center min-w-[60px] py-2 rounded-xl transition-all duration-300 ${isActive ? 'bg-[#c5a059] text-[#121212] shadow-[0_0_15px_rgba(197,160,89,0.3)] transform scale-105' : 'bg-[#1e1e1e] text-gray-400 border border-white/5'}`}>
                                        <span className={`text-xs font-bold font-serif mb-1 ${isActive ? 'text-[#121212]' : 'text-gray-500'}`}>{date}</span>
                                        <span className={`text-lg font-bold ${isActive ? 'text-black' : 'text-gray-300'}`}>{WEEKDAYS[date]}</span>
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {/* 3. Itinerary List */}
                    <div className="px-4 py-6 max-w-lg mx-auto">
                        {filteredItems.length === 0 ? (
                            <div className="text-center py-20 text-gray-600 flex flex-col items-center">
                                <Camera size={48} className="mb-4 opacity-20" />
                                <p className="text-sm font-serif">今日暫無行程</p>
                                <button onClick={handleAddNew} className="mt-4 text-[#c5a059] text-sm hover:underline">新增一個行程</button>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {filteredItems.map((item, index) => {
                                    const style = getCatStyle(item.category);
                                    // 修正舊版會存壞 Icon 的問題，改用字串對應
                                    const IconRender = typeof style.icon === 'string' ? (Icons[style.icon] || MapPin) : (style.icon || MapPin);
                                    
                                    return (
                                        <div key={item.id} className="group relative bg-[#1e1e1e] rounded-xl border border-white/5 overflow-hidden transition-all duration-300 hover:border-[#c5a059]/30 hover:shadow-lg active:scale-[0.99]" draggable onDragStart={(e) => handleDragStart(e, index)} onDragEnter={(e) => handleDragEnter(e, index)} onDragEnd={handleDrop} onDragOver={(e) => e.preventDefault()} onClick={() => setEditingItem(item)}>
                                            <div className="flex items-stretch min-h-[5rem]">
                                                <div className="w-16 flex flex-col items-center justify-center border-r border-white/5 bg-[#252525]">
                                                    <span className="text-sm font-bold text-gray-300 font-mono tracking-tighter">{item.time}</span>
                                                    <div className={`h-8 w-[1px] my-1 ${(style.bg || '').replace('/10', '/50')}`} />
                                                    <IconRender size={14} className={style.color} />
                                                </div>
                                                <div className="flex-1 p-3 flex flex-col justify-center min-w-0">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded border ${style.color} ${style.bg} ${style.border}`}>{item.category}</span>
                                                    </div>
                                                    <h3 className="text-base font-bold text-gray-100 truncate pr-2 font-serif leading-tight">{item.title}</h3>
                                                    {(item.memo || item.link) && (
                                                        <div className="mt-2 flex flex-wrap gap-2 text-xs text-gray-400">
                                                            {item.link && (
                                                                <a href={item.link} target="_blank" rel="noopener noreferrer" className="flex items-center gap-1 text-[#c5a059] hover:text-white transition-colors bg-[#c5a059]/10 px-2 py-0.5 rounded" onClick={(e) => e.stopPropagation()}>
                                                                    <Navigation size={10} /> 導航
                                                                </a>
                                                            )}
                                                            {item.memo && <span className="flex-1 truncate opacity-70 border-l border-gray-600 pl-2">{renderMemoWithLinks(item.memo)}</span>}
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="w-8 flex items-center justify-center text-gray-600 cursor-grab active:cursor-grabbing hover:text-gray-400 bg-gradient-to-l from-black/20 to-transparent">
                                                    <GripVertical size={16} />
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                        <div className="h-24"></div>
                    </div>

                    {/* 4. Floating Action Button */}
                    <button onClick={handleAddNew} className="fixed bottom-6 right-6 w-14 h-14 bg-[#c5a059] text-black rounded-full shadow-[0_4px_20px_rgba(197,160,89,0.4)] flex items-center justify-center hover:bg-[#d4b06a] hover:scale-110 transition-all z-30">
                        <Plus size={28} />
                    </button>

                    {/* 5. Edit Modal */}
                    <EditModal 
                        key={editingItem ? editingItem.id : 'edit-modal'} 
                        item={editingItem} 
                        isOpen={!!editingItem} 
                        onClose={() => setEditingItem(null)} 
                        onSave={handleSave}
                        onDelete={handleDelete}
                        categories={categories}
                        onUpdateCategories={(newCategories) => updateFirestore(items, newCategories)}
                    />
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<FukuokaSoloTripApp />);
    </script>
</body>
</html>
